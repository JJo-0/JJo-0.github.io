---
import type { GetStaticPaths } from 'astro';
import Layout from '@/layouts/Layout.astro';
import PostCard from '@/components/PostCard.svelte';
import Breadcrumbs from '@/components/Breadcrumbs.svelte';
import { getBreadcrumbSchema, getCollectionPageSchema } from '@/lib/schemas';
import { getReadTime } from '@/lib/utils/readTime';
import { getPublishedPosts, getPostSlug } from '@/lib/utils/posts';
import { SITE } from '@/config';

export const getStaticPaths = (async () => {
  const posts = await getPublishedPosts();
  const allTags = Array.from(new Set(posts.flatMap((post) => post.data.tags || [])));

  return allTags.map((tag) => {
    const filteredPosts = posts
      .filter((post) => post.data.tags?.includes(tag))
      .sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

    return {
      params: { tag },
      props: { tag, posts: filteredPosts },
    };
  });
}) satisfies GetStaticPaths;

const { tag, posts } = Astro.props;

const breadcrumbSchema = getBreadcrumbSchema([
  { name: 'Blog', url: new URL('/posts', Astro.site).toString() },
  { name: tag, url: new URL(Astro.url.pathname, Astro.site).toString() },
]);

const collectionSchema = getCollectionPageSchema({
  name: `Posts tagged "${tag}"`,
  description: `${posts.length} posts about ${tag} on ${SITE.title}.`,
  url: new URL(Astro.url.pathname, Astro.site).toString(),
  items: posts.map((post) => ({
    name: post.data.title,
    url: new URL(`/posts/${getPostSlug(post)}`, Astro.site).toString(),
    datePublished: post.data.pubDate,
  })),
});

const tagRelatedKeywords = Array.from(
  new Set(posts.flatMap((post) => post.data.tags || []).filter(Boolean))
).slice(0, 8);
const shouldIndexTagPage = posts.length >= 2;
---

<Layout
  title={`Posts tagged with "${tag}"`}
  description={`Blog posts tagged with ${tag}`}
  keywords={[tag, ...tagRelatedKeywords]}
  robots={shouldIndexTagPage ? 'index, follow' : 'noindex, follow'}
  schema={[breadcrumbSchema, collectionSchema]}
>
  <Breadcrumbs
    items={[
      { name: 'Blog', href: '/posts' },
      { name: `#${tag}`, href: '#' },
    ]}
  />

  <div class="mb-10 sm:mb-12">
    <h1
      class="text-3xl sm:text-4xl lg:text-5xl font-black tracking-tight text-foreground leading-[1.1]"
    >
      Topic: <span class="text-primary">#{tag}</span>
    </h1>
    <p class="mt-3 text-base sm:text-lg text-muted-foreground max-w-2xl leading-relaxed">
      {`A collection of ${posts.length} ${posts.length === 1 ? 'post' : 'posts'} about ${tag}.`}
    </p>
  </div>

  <div class="flex flex-col gap-3 sm:gap-4">
    {
      posts.map((post) => (
        <PostCard post={post} slug={getPostSlug(post)} readTime={getReadTime(post.body || '')} />
      ))
    }
  </div>
</Layout>
