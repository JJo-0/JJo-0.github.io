---
import Layout from '@/layouts/Layout.astro';
import { render, type CollectionEntry } from 'astro:content';
import { formatDate } from '@/lib/utils/date';
import TableOfContents from '@/components/TableOfContents.svelte';
import { getPublishedPosts, getPostSlug } from '@/lib/utils/posts';

import Breadcrumbs from '@/components/Breadcrumbs.svelte';
import SocialShare from '@/components/SocialShare.svelte';
import SeriesNavigation from '@/components/SeriesNavigation.astro';
import LanguageSelector from '@/components/LanguageSelector.svelte';
import CTABlock from '@/components/CTABlock.astro';
import Comments from '@/components/Comments.svelte';
import { getBlogPostingSchema, getBreadcrumbSchema } from '@/lib/schemas';

export async function getStaticPaths() {
  const posts = await getPublishedPosts();
  return posts.map((post: CollectionEntry<'posts'>) => ({
    params: { slug: getPostSlug(post) },
    props: post,
  }));
}

type Props = CollectionEntry<'posts'>;

const post = Astro.props as Props;
const { Content, headings } = await render(post);

const effectiveSlug = getPostSlug(post);
const modifiedDate = post.data.updatedDate || post.data.pubDate;
const allPosts = await getPublishedPosts();
const currentTags = new Set(post.data.tags || []);

const relatedPosts = allPosts
  .filter((candidate) => candidate.id !== post.id)
  .map((candidate) => {
    const sharedTags = (candidate.data.tags || []).filter((tag) => currentTags.has(tag));
    return { candidate, sharedTagCount: sharedTags.length };
  })
  .filter((entry) => entry.sharedTagCount > 0)
  .sort(
    (a, b) =>
      b.sharedTagCount - a.sharedTagCount ||
      b.candidate.data.pubDate.getTime() - a.candidate.data.pubDate.getTime()
  )
  .slice(0, 4)
  .map((entry) => entry.candidate);

const schemas = [
  getBlogPostingSchema({
    title: post.data.title,
    description: post.data.description,
    pubDate: post.data.pubDate,
    updatedDate: post.data.updatedDate,
    url: new URL(Astro.url.pathname, Astro.site).toString(),
    canonicalURL: post.data.canonicalURL,
    lang: post.data.lang,
    image: new URL(`/og/${effectiveSlug}.png`, Astro.site).toString(),
    tags: post.data.tags,
  }),
  getBreadcrumbSchema([
    { name: 'Blog', url: new URL('/posts', Astro.site).toString() },
    { name: post.data.title, url: new URL(Astro.url.pathname, Astro.site).toString() },
  ]),
];
---

<Layout
  title={post.data.title}
  description={post.data.description}
  lang={post.data.lang}
  ogImage={`/og/${effectiveSlug}.png`}
  keywords={post.data.tags}
  publishedTime={post.data.pubDate.toISOString()}
  modifiedTime={modifiedDate.toISOString()}
  canonicalUrl={post.data.canonicalURL}
  alternateLanguages={post.data.translatedPosts}
  schema={schemas}
>
  <Breadcrumbs
    items={[
      { name: 'Blog', href: '/posts' },
      { name: post.data.title, href: '#' },
    ]}
  />

  <div class="lg:flex lg:gap-16">
    <!-- Main Content -->
    <div class="flex-1 min-w-0">
      <div class="mb-8">
        <header class="flex flex-col gap-4">
          <div
            class="flex flex-wrap items-center gap-x-3 gap-y-2 text-xs text-muted-foreground font-bold uppercase tracking-widest"
          >
            <time datetime={post.data.pubDate.toISOString()}>
              {formatDate(post.data.pubDate)}
            </time>
            {
              post.data.draft && (
                <>
                  <span class="hidden sm:inline text-border">•</span>
                  <div class="flex items-center gap-1.5 text-amber-600 dark:text-amber-400 bg-amber-100 dark:bg-amber-900/30 px-2 py-1 rounded">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-3.5 w-3.5"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
                        clip-rule="evenodd"
                      />
                    </svg>
                    Draft
                  </div>
                </>
              )
            }
            {
              post.data.tags && post.data.tags.length > 0 && (
                <>
                  <span class="hidden sm:inline text-border">•</span>
                  <div class="flex flex-wrap gap-2 text-xs uppercase font-bold tracking-widest text-muted-foreground/80">
                    {post.data.tags.map((tag: string) => (
                      <a
                        href={`/posts/tag/${encodeURIComponent(tag)}`}
                        rel="tag"
                        class="opacity-80 hover:opacity-100 hover:text-primary transition-colors no-underline"
                      >
                        #{tag}
                      </a>
                    ))}
                  </div>
                </>
              )
            }
          </div>

          <h1 class="text-3xl font-black tracking-tight text-foreground sm:text-4xl lg:text-5xl">
            {post.data.title}
          </h1>

          <p class="text-lg text-muted-foreground italic border-l-2 border-primary/20 pl-4 py-1">
            {post.data.description}
          </p>
        </header>

        {
          post.data.series && (
            <SeriesNavigation seriesId={post.data.series.id} currentPostId={post.id} />
          )
        }

        {
          post.data.translatedPosts && (
            <LanguageSelector client:load translations={post.data.translatedPosts} />
          )
        }
      </div>

      <article class="prose max-w-none mt-12 mb-16">
        <Content />
      </article>

      {
        relatedPosts.length > 0 && (
          <section class="mt-12 mb-16 border-t border-border/50 pt-8">
            <h2 class="text-xs font-black uppercase tracking-[0.2em] text-muted-foreground mb-5">
              Related Posts
            </h2>
            <div class="grid gap-4 sm:grid-cols-2">
              {relatedPosts.map((related) => (
                <article class="rounded-xl border border-border/60 bg-secondary/20 p-4 hover:bg-secondary/30 transition-colors">
                  <a
                    href={`/posts/${getPostSlug(related)}`}
                    class="no-underline text-foreground hover:text-primary transition-colors"
                  >
                    <h3 class="font-bold leading-snug line-clamp-2 mb-2">{related.data.title}</h3>
                  </a>
                  <p class="text-sm text-muted-foreground line-clamp-2 mb-3">
                    {related.data.description}
                  </p>
                  <div class="flex flex-wrap items-center gap-2 text-xs uppercase tracking-wide">
                    <time datetime={related.data.pubDate.toISOString()} class="text-muted-foreground">
                      {formatDate(related.data.pubDate)}
                    </time>
                    {(related.data.tags || [])
                      .filter((tag) => currentTags.has(tag))
                      .slice(0, 2)
                      .map((tag) => (
                        <a
                          href={`/posts/tag/${encodeURIComponent(tag)}`}
                          rel="tag"
                          class="px-1.5 py-0.5 rounded bg-background border border-border text-muted-foreground hover:text-primary hover:border-primary/40 transition-colors no-underline"
                        >
                          #{tag}
                        </a>
                      ))}
                  </div>
                </article>
              ))}
            </div>
          </section>
        )
      }

      {post.data.showCTA !== false && <CTABlock />}

      <SocialShare client:load title={post.data.title} urlPath={Astro.url.pathname} />

      {post.data.showComments !== false && <Comments client:load />}
    </div>

    <!-- Sidebar (TOC) -->
    <div class="hidden lg:block w-64 flex-shrink-0">
      <TableOfContents client:load {headings} />
    </div>
  </div>
</Layout>
